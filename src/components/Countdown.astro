---
import NumberCard from "./NumberCard.astro";
const { TIMESTAMP_END, title, subtitle, type } = Astro.props;
---

<section
  data-date={TIMESTAMP_END}
  class="grid grid-cols-4 gap-2 max-w-3xl select-none hover:cursor-crosshair"
  data-type={type}
>
  <NumberCard>
    <span class="text-5xl font-bold" data-days>00</span>
    <span>DÍAS</span>
  </NumberCard>
  <NumberCard>
    <span class="text-5xl font-bold" data-hours>00</span>
    <span>HORAS</span>
  </NumberCard>
  <NumberCard>
    <span class="text-5xl font-bold" data-minutes>00</span>
    <span>MINUTOS</span>
  </NumberCard>
  <NumberCard>
    <span class="text-5xl font-bold" data-seconds>00</span>
    <span>SEGUNDOS</span>
  </NumberCard>
</section>
<section id="its-time" class="hidden">
  <div
    class="flex flex-col border border-gray-400 p-4 gap-4 justify-center items-center rounded"
  >
    <h2 class="text-4xl text-[#D52941] font-bold text-center">
      {title}
    </h2>
    <p class="text-center">
      {subtitle}
    </p>
    <small class="text-gray-400"
      >La nueva cuenta regresiva para {type == "christmas" ? "Navidad" : type} comienza
      mañana</small
    >
  </div>
</section>

<script>
  import { snowAnimation } from "@utils/snowAnimation";
  import { fireworksAnimation } from "@utils/fireworksAnimation";
  const $ = (s: string) => document.querySelector(s);
  const SECONDS = 1000;
  const MINUTES = SECONDS * 60;
  const HOURS = MINUTES * 60;
  const DAYS = HOURS * 24;

  function init() {
    const $countdown = $("[data-date]");

    if (!$countdown) return;
    const $days = $countdown.querySelector("[data-days]");
    const $hours = $countdown.querySelector("[data-hours]");
    const $minutes = $countdown.querySelector("[data-minutes]");
    const $seconds = $countdown.querySelector("[data-seconds]");
    const timestamp = $countdown.getAttribute("data-date");
    if (!timestamp) return;
    let date = new Date(+timestamp).getTime();

    function formatTime(time: number) {
      return Math.floor(time).toString().padStart(2, "0");
    }

    function updateCountdown() {
      const now = Date.now();
      const today = new Date();
      if (!timestamp) return;
      const dateEnd = new Date(+timestamp);
      if (
        dateEnd.getDate() < today.getDate() &&
        dateEnd.getMonth() <= today.getMonth() &&
        dateEnd.getFullYear() <= today.getFullYear()
      ) {
        date = new Date(
          dateEnd.getFullYear() + 1,
          dateEnd.getMonth(),
          dateEnd.getDate(),
          dateEnd.getHours(),
          dateEnd.getMinutes(),
          dateEnd.getSeconds()
        ).getTime();
      }
      const distance = date - now;
      if (distance < 0) {
        if (!timestamp) return;
        const dateEnd = new Date(+timestamp);
        if (dateEnd.getDate() == new Date().getDate() && $countdown) {
          $countdown.className = "hidden";
          const $itsTime = $("#its-time");
          if ($itsTime instanceof HTMLElement) {
            $itsTime.className = "";
            let interval = setInterval(() => fireworksAnimation(interval), 350);
          }
        }
      }
      if (!$countdown) return;
      const type = $countdown.getAttribute("data-type");
      if (type === "christmas") {
        snowAnimation();
      }
      if ($days instanceof HTMLElement) {
        $days.innerText = formatTime(distance / DAYS);
      }
      if ($hours instanceof HTMLElement) {
        $hours.innerText = formatTime((distance % DAYS) / HOURS);
      }
      if ($minutes instanceof HTMLElement) {
        $minutes.innerText = formatTime((distance % HOURS) / MINUTES);
      }
      if ($seconds instanceof HTMLElement) {
        $seconds.innerText = formatTime((distance % MINUTES) / SECONDS);
      }
    }

    setInterval(updateCountdown, 1000);
  }

  init();
</script>
